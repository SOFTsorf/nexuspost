<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NexusPost Pro</title>
    <link rel="icon" type="image/png" href="https://lh3.googleusercontent.com/u/0/d/1FWT62V69b4nS8Ldba8f96J8xvShlrHT6">

    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --nexus: #1877f2; --bg: #f0f2f5; --card: #ffffff;
            --text: #050505; --sub: #65676b; --border: #dddfe2; --header-bg: rgba(255, 255, 255, 0.95);
            --input-bg: #f0f2f5; --nav-bg: #ffffff;
            --danger: #ff3b30;
            --safe-bottom: env(safe-area-inset-bottom);
        }
        body.dark {
            --bg: #000000; --card: #1c1c1e; --text: #e4e6eb;
            --sub: #b0b3b8; --border: #2c2c2e; --header-bg: rgba(28, 28, 30, 0.95);
            --input-bg: #2c2c2e; --nav-bg: #1c1c1e;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; 
            overflow: hidden; /* Wichtig fÃ¼r Swipe */
            height: 100vh; width: 100vw;
            -webkit-tap-highlight-color: transparent;
        }

        /* HEADER */
        nav.top-nav {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: var(--header-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            display: flex; justify-content: space-between; align-items: center; padding: 0 15px;
            border-bottom: 0.5px solid var(--border); z-index: 1000;
        }
        .logo { font-size: 22px; font-weight: 800; color: var(--nexus); letter-spacing: -1px; }

        /* SEARCH ANIMATION */
        .search-wrapper { display: flex; align-items: center; gap: 0; transition: all 0.3s ease; flex-grow: 0; justify-content: flex-end; }
        .search-wrapper.active { flex-grow: 1; gap: 10px; }
        .search-container {
            display: flex; align-items: center; background: var(--input-bg);
            border-radius: 50px; padding: 0 10px; height: 36px;
            width: 36px; transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer; overflow: hidden;
        }
        .search-wrapper.active .search-container { width: 100%; cursor: text; }
        .search-input { border: none; background: none; color: var(--text); font-size: 15px; width: 0; outline: none; padding: 0; transition: width 0.3s; }
        .search-wrapper.active .search-input { width: 100%; padding-left: 8px; }
        .btn-close-search { background: none; border: none; color: var(--nexus); font-weight: 600; font-size: 15px; cursor: pointer; display: none; opacity: 0; }
        .search-wrapper.active .btn-close-search { display: block; opacity: 1; }

        /* MAIN SWIPE CONTAINER */
        #views-container {
            position: absolute; top: 51px; bottom: 51px; left: 0; width: 300%; /* 3 Tabs */
            display: flex; transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
        }
        .view-section {
            width: 33.333%; height: 100%; overflow-y: auto;
            position: relative; -webkit-overflow-scrolling: touch;
        }

        /* TAB 1: FEED & COMPOSE */
        .feed-wrapper { max-width: 600px; margin: 0 auto; padding-bottom: 20px; }
        
        /* COMPOSE CARD (Neuer Post Bereich oben) */
        .compose-card {
            background: var(--card); padding: 15px; 
            border-bottom: 0.5px solid var(--border);
            margin-bottom: 10px;
        }
        .compose-row { display: flex; gap: 12px; }
        .user-avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; background: var(--input-bg); }
        .compose-input {
            flex-grow: 1; border: none; background: transparent; 
            color: var(--text); font-size: 16px; outline: none; 
            min-height: 40px; resize: none; font-family: inherit; margin-top: 8px;
        }
        .compose-actions {
            display: flex; justify-content: space-between; align-items: center;
            margin-top: 10px; padding-left: 52px; /* Align with text */
        }
        .action-btn { background: none; border: none; color: var(--nexus); cursor: pointer; padding: 5px; border-radius: 50%; }
        .post-btn {
            background: var(--nexus); color: white; border: none; 
            padding: 6px 16px; border-radius: 20px; font-weight: 700; font-size: 14px;
            cursor: pointer; opacity: 0.5; pointer-events: none; transition: 0.2s;
        }
        .post-btn.active { opacity: 1; pointer-events: all; }

        /* POST CARD */
        .card { background: var(--card); margin-bottom: 8px; padding: 15px; border-top: 0.5px solid var(--border); border-bottom: 0.5px solid var(--border); }
        .post-header { display: flex; gap: 10px; margin-bottom: 8px; }
        .display-name { font-weight: 700; font-size: 15px; color: var(--text); display: flex; align-items: center; }
        .username { font-size: 14px; color: var(--sub); font-weight: 400; margin-left: 4px; }
        .verified { width: 16px; height: 16px; margin-left: 4px; vertical-align: middle; }
        .post-text { font-size: 15px; line-height: 1.4; white-space: pre-wrap; margin-bottom: 10px; }
        .post-img { width: 100%; border-radius: 12px; border: 0.5px solid var(--border); margin-top: 5px; cursor: zoom-in; }
        .post-footer { display: flex; gap: 20px; margin-top: 12px; }
        .footer-btn { background: none; border: none; color: var(--sub); display: flex; align-items: center; gap: 5px; font-size: 13px; cursor: pointer; }
        .footer-btn.liked { color: var(--danger); }
        .footer-btn.liked svg { fill: var(--danger); stroke: var(--danger); }

        /* TAB 2: KI */
        iframe { width: 100%; height: 100%; border: none; }

        /* TAB 3: SETTINGS */
        .settings-container { padding: 20px 15px; max-width: 600px; margin: 0 auto; }
        .settings-card { background: var(--card); border-radius: 10px; overflow: hidden; border: 0.5px solid var(--border); margin-bottom: 15px; }
        .set-row { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 0.5px solid var(--border); }
        .set-row:last-child { border-bottom: none; }
        .set-row label { font-size: 15px; font-weight: 500; }
        .set-row input { text-align: right; background: none; border: none; color: var(--nexus); font-size: 15px; outline: none; width: 60%; }

        /* BOTTOM NAV BAR (AMAZON STYLE) */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; right: 0; height: 50px;
            background: var(--nav-bg); border-top: 0.5px solid var(--border);
            display: flex; justify-content: space-around; align-items: center;
            padding-bottom: var(--safe-bottom); z-index: 2000;
        }
        .nav-btn {
            background: none; border: none; flex-grow: 1; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            color: var(--sub); cursor: pointer; position: relative;
        }
        .nav-btn svg { width: 24px; height: 24px; stroke-width: 2px; transition: 0.2s; }
        .nav-btn.active { color: var(--nexus); }
        .nav-btn.active svg { stroke-width: 2.5px; }
        .nav-indicator {
            position: absolute; top: 0; width: 40px; height: 3px; background: var(--nexus);
            border-bottom-left-radius: 3px; border-bottom-right-radius: 3px;
            display: none;
        }
        .nav-btn.active .nav-indicator { display: block; }

        /* UTILS */
        .hidden { display: none !important; }
        .preview-box { position: relative; display: inline-block; margin-top: 10px; }
        .preview-box img { height: 80px; border-radius: 8px; }
        .preview-box button { position: absolute; top: -5px; right: -5px; background: rgba(0,0,0,0.6); color: white; border-radius: 50%; width: 20px; height: 20px; border: none; font-size: 12px; cursor: pointer; }
        .lightbox { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 3000; display: none; justify-content: center; align-items: center; }
        
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
    </style>
</head>
<body class="light">

<div id="login-screen">
    <div style="font-size: 50px; font-weight: 900; color: var(--nexus); letter-spacing: -2px; margin-bottom: 10px;">NexusPost</div>
    <div style="color: var(--sub); margin-bottom: 30px;">Connect with your world.</div>
    <button id="btn-login" style="background:var(--text); color:var(--bg); border:none; padding:14px 40px; border-radius:30px; font-weight:700; font-size:16px; cursor:pointer;">Mit Google fortfahren</button>
</div>

<nav id="top-nav" class="top-nav hidden">
    <div class="logo" id="nav-logo">NexusPost</div>
    <div class="search-wrapper" id="search-wrapper">
        <div class="search-container" onclick="expandSearch()">
            <i data-lucide="search" style="width:18px; color:var(--sub); flex-shrink:0;"></i>
            <input type="text" class="search-input" id="search-input" placeholder="Suche">
        </div>
        <button class="btn-close-search" onclick="collapseSearch()">Fertig</button>
    </div>
    <button onclick="toggleTheme()" style="background:none; border:none; color:var(--text); margin-left:10px;"><i data-lucide="moon" id="theme-icon"></i></button>
</nav>

<div id="views-container" class="hidden">
    
    <div class="view-section" id="view-home">
        <div class="feed-wrapper">
            <div class="compose-card">
                <div class="compose-row">
                    <img id="my-avatar" src="" class="user-avatar-small">
                    <div style="flex-grow:1;">
                        <textarea id="post-text" class="compose-input" placeholder="Was gibt's Neues?" oninput="checkInput()"></textarea>
                        <div id="preview-area" class="preview-box hidden">
                            <img id="preview-img">
                            <button onclick="clearImage()">âœ•</button>
                        </div>
                    </div>
                </div>
                <div class="compose-actions">
                    <label class="action-btn">
                        <i data-lucide="image"></i>
                        <input type="file" id="file-input" hidden accept="image/*" onchange="handleFile(event)">
                    </label>
                    <button id="btn-post" class="post-btn" onclick="createPost()">Posten</button>
                </div>
            </div>
            
            <div id="feed"></div>
        </div>
    </div>

    <div class="view-section" id="view-ki">
        <iframe src="https://softsorf.github.io/Ki-assistent/"></iframe>
    </div>

    <div class="view-section" id="view-settings">
        <div class="settings-container">
            <h2 style="margin-bottom: 20px;">Einstellungen</h2>
            <div class="settings-card">
                <div class="set-row">
                    <label>Anzeigename</label>
                    <input type="text" id="set-displayname">
                </div>
                <div class="set-row">
                    <label>Nutzername</label>
                    <input type="text" id="set-username">
                </div>
            </div>
            <p style="font-size: 13px; color: var(--sub); padding: 0 10px; line-height: 1.4;">
                Hinweis: Aus SicherheitsgrÃ¼nden kannst du deinen Namen nur <strong>2 Mal innerhalb von 14 Tagen</strong> Ã¤ndern.
            </p>
            <button onclick="saveSettings()" style="width:100%; background:var(--nexus); color:white; padding:15px; border:none; border-radius:12px; font-weight:600; font-size:16px; margin-top:20px;">Speichern</button>
            <button onclick="signOutUser()" style="width:100%; background:transparent; color:var(--danger); padding:15px; border:none; font-weight:600; font-size:16px; margin-top:10px;">Abmelden</button>
        </div>
    </div>

</div>

<nav id="bottom-nav" class="bottom-nav hidden">
    <button class="nav-btn active" onclick="switchTab(0)">
        <div class="nav-indicator"></div>
        <i data-lucide="home"></i>
    </button>
    <button class="nav-btn" onclick="switchTab(1)">
        <div class="nav-indicator"></div>
        <i data-lucide="bot"></i>
    </button>
    <button class="nav-btn" onclick="switchTab(2)">
        <div class="nav-indicator"></div>
        <i data-lucide="settings"></i>
    </button>
</nav>

<div id="lightbox" class="lightbox" onclick="this.style.display='none'">
    <img id="lightbox-img" src="" style="max-width:100%; max-height:100%;">
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const config = {
        apiKey: "AIzaSyCK6bbGtKyuLphYGtxqnAvvnGtMyh2ejV4",
        authDomain: "nexuspost-a00b1.firebaseapp.com",
        projectId: "nexuspost-a00b1",
        storageBucket: "nexuspost-a00b1.firebasestorage.app",
        messagingSenderId: "124843068065",
        appId: "1:124843068065:web:035b15d01910dc6b8d7ee0"
    };

    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    const IMG_KEY = "1cb3871dd6829d7133f3285c289ffc0a";
    const ADMIN = "boxenjob5@gmail.com";
    const VERIFIED_IMG = "https://lh3.googleusercontent.com/d/1c-ECuznD4JebaHyVW7X3FmYG6PggkMsT";

    let currentUserData = null;
    let selectedImage = null;

    // --- TABS & SWIPE ---
    window.switchTab = (idx) => {
        // Container verschieben
        document.getElementById('views-container').style.transform = `translateX(-${idx * 33.333}%)`;
        
        // Icons updaten
        const btns = document.querySelectorAll('.nav-btn');
        btns.forEach((b, i) => b.classList.toggle('active', i === idx));

        // Settings laden wenn Tab 2
        if(idx === 2 && currentUserData) {
            document.getElementById('set-displayname').value = currentUserData.displayname;
            document.getElementById('set-username').value = currentUserData.username;
        }
    };

    // --- SEARCH ---
    window.expandSearch = () => {
        document.getElementById('nav-logo').classList.add('hidden');
        document.getElementById('search-wrapper').classList.add('active');
        setTimeout(()=>document.getElementById('search-input').focus(), 100);
    };
    window.collapseSearch = () => {
        document.getElementById('search-wrapper').classList.remove('active');
        document.getElementById('search-input').value = "";
        document.querySelectorAll('.card').forEach(c => c.style.display = 'block');
        setTimeout(()=>document.getElementById('nav-logo').classList.remove('hidden'), 200);
    };
    document.getElementById('search-input').oninput = (e) => {
        const t = e.target.value.toLowerCase();
        document.querySelectorAll('.card').forEach(c => c.style.display = c.innerText.toLowerCase().includes(t)?'block':'none');
    };

    // --- POST CREATION ---
    window.checkInput = () => {
        const txt = document.getElementById('post-text').value.trim();
        const btn = document.getElementById('btn-post');
        if(txt || selectedImage) btn.classList.add('active');
        else btn.classList.remove('active');
    };
    window.handleFile = (e) => {
        const f = e.target.files[0];
        if(f) {
            selectedImage = f;
            const r = new FileReader();
            r.onload = (res) => {
                document.getElementById('preview-img').src = res.target.result;
                document.getElementById('preview-area').classList.remove('hidden');
                checkInput();
            };
            r.readAsDataURL(f);
        }
    };
    window.clearImage = () => {
        selectedImage = null;
        document.getElementById('file-input').value = "";
        document.getElementById('preview-area').classList.add('hidden');
        checkInput();
    };
    window.createPost = async () => {
        const txt = document.getElementById('post-text').value;
        if(!txt && !selectedImage) return;

        // Button disable
        const btn = document.getElementById('btn-post');
        btn.innerHTML = "...";
        
        let url = null;
        if(selectedImage) {
            const fd = new FormData(); fd.append("image", selectedImage);
            const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_KEY}`, { method:"POST", body:fd });
            const j = await res.json();
            url = j.data.url;
        }

        await addDoc(collection(db, "posts"), {
            text: txt, imageUrl: url,
            uid: auth.currentUser.uid,
            timestamp: serverTimestamp(),
            likes: []
        });

        // Reset
        document.getElementById('post-text').value = "";
        clearImage();
        btn.innerHTML = "Posten";
        checkInput();
    };

    // --- SETTINGS (14 TAGE LIMIT) ---
    window.saveSettings = async () => {
        const dn = document.getElementById('set-displayname').value.trim();
        const un = document.getElementById('set-username').value.trim().replace('@','');
        if(!dn || !un) return;

        const now = Date.now();
        const history = currentUserData.nameChangeHistory || [];
        // Filtere Ã„nderungen der letzten 14 Tage (14 * 24 * 60 * 60 * 1000 ms)
        const recent = history.filter(ts => now - ts < 1209600000);

        if(auth.currentUser.email !== ADMIN && recent.length >= 2) {
            alert("Du hast deinen Namen in den letzten 14 Tagen bereits 2 Mal geÃ¤ndert.");
            return; // Abbruch
        }

        const newHistory = [...recent, now];
        await updateDoc(doc(db, "users", auth.currentUser.uid), {
            displayname: dn, username: un, nameChangeHistory: newHistory
        });
        currentUserData.displayname = dn; currentUserData.username = un; 
        currentUserData.nameChangeHistory = newHistory;
        alert("Profil aktualisiert!");
    };
    window.signOutUser = () => signOut(auth).then(()=>location.reload());

    // --- AUTH & LOAD ---
    document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
    
    onAuthStateChanged(auth, async (user) => {
        if(user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('top-nav').classList.remove('hidden');
            document.getElementById('views-container').classList.remove('hidden');
            document.getElementById('bottom-nav').classList.remove('hidden');
            
            const ref = doc(db, "users", user.uid);
            const snap = await getDoc(ref);
            if(snap.exists()) {
                currentUserData = snap.data();
            } else {
                currentUserData = {
                    displayname: user.displayName,
                    username: "user" + Math.floor(Math.random()*10000),
                    photoURL: user.photoURL,
                    email: user.email,
                    verified: (user.email === ADMIN),
                    nameChangeHistory: []
                };
                await setDoc(ref, currentUserData);
            }
            document.getElementById('my-avatar').src = currentUserData.photoURL;
            loadFeed();
            lucide.createIcons();
            
            // Check Theme
            if(localStorage.getItem('theme')==='dark') {
                document.body.classList.add('dark');
                document.body.classList.remove('light');
            }
        }
    });

    function loadFeed() {
        onSnapshot(query(collection(db, "posts"), orderBy("timestamp", "desc")), (snap) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = ""; // Clear for redraw (einfacher als diffing hier)
            snap.forEach(d => {
                const p = d.data();
                // User Daten holen (kÃ¶nnte man cachen, aber so ist es live)
                getDoc(doc(db, "users", p.uid)).then(uSnap => {
                    const u = uSnap.data() || {displayname:"Unbekannt", username:"?", photoURL:""};
                    const isLiked = (p.likes||[]).includes(auth.currentUser.uid);
                    
                    const el = document.createElement('div');
                    el.className = "card";
                    el.innerHTML = `
                        <div class="post-header">
                            <img src="${u.photoURL}" style="width:40px; height:40px; border-radius:50%; object-fit:cover;">
                            <div>
                                <div class="display-name">${u.displayname} ${u.verified ? `<img src="${VERIFIED_IMG}" class="verified">` : ''}</div>
                                <div class="username">@${u.username}</div>
                            </div>
                            ${auth.currentUser.email === ADMIN ? `<button onclick="delPost('${d.id}')" style="margin-left:auto; background:none; border:none;">ðŸ—‘</button>` : ''}
                        </div>
                        <div class="post-text">${p.text}</div>
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="post-img" onclick="openLight('${p.imageUrl}')">` : ''}
                        <div class="post-footer">
                            <button class="footer-btn ${isLiked?'liked':''}" onclick="likePost('${d.id}')">
                                <i data-lucide="heart" style="width:18px; ${isLiked?'fill:var(--danger)':''}"></i>
                                ${p.likes ? p.likes.length : 0}
                            </button>
                            <button class="footer-btn">
                                <i data-lucide="message-circle" style="width:18px;"></i>
                            </button>
                        </div>
                    `;
                    feed.appendChild(el);
                    lucide.createIcons();
                });
            });
        });
    }

    // --- ACTIONS ---
    window.likePost = async (pid) => {
        const uid = auth.currentUser.uid;
        const ref = doc(db, "posts", pid);
        const snap = await getDoc(ref);
        const likes = snap.data().likes || [];
        if(likes.includes(uid)) await updateDoc(ref, { likes: arrayRemove(uid) });
        else await updateDoc(ref, { likes: arrayUnion(uid) });
    };
    window.delPost = (id) => confirm("LÃ¶schen?") && deleteDoc(doc(db, "posts", id));
    window.openLight = (u) => { document.getElementById('lightbox-img').src=u; document.getElementById('lightbox').style.display='flex'; };
    window.toggleTheme = () => {
        document.body.classList.toggle('dark');
        document.body.classList.toggle('light');
        localStorage.setItem('theme', document.body.classList.contains('dark') ? 'dark' : 'light');
    };

</script>
</body>
</html>
