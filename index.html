<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NexusPost | Willkommen</title>
    <style>
        :root { --nexus-blue: #1877f2; --bg-gray: #f0f2f5; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: var(--bg-gray); margin: 0; }
        
        .hidden { display: none !important; }
        .container { max-width: 550px; margin: 20px auto; padding: 0 10px; }
        
        /* UI Elements */
        nav { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* Setup Screen */
        .setup-screen { text-align: center; padding: 40px; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        
        /* Buttons */
        .btn { background: var(--nexus-blue); color: white; border: none; padding: 12px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; }
        .btn:disabled { background: #ccc; }

        /* Post Style */
        .post { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; position: relative; }
        .user-img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; }
        .verified-badge { width: 16px; height: 16px; vertical-align: middle; }
        .handle { color: #65676b; font-size: 14px; }
    </style>
</head>
<body>

<div id="login-screen" class="setup-screen">
    <h1 style="color: var(--nexus-blue);">NexusPost</h1>
    <button id="btn-login" class="btn">Mit Google anmelden</button>
</div>

<div id="setup-screen" class="container hidden">
    <div class="card">
        <h2>Profil vervollst√§ndigen</h2>
        <p>W√§hle einen einzigartigen Benutzernamen:</p>
        <input type="text" id="setup-username" placeholder="@benutzername (nur Kleinbuchstaben/Zahlen)">
        <input type="text" id="setup-displayname" placeholder="Anzeigename (z.B. Max Mustermann)">
        <p style="font-size: 12px; color: #666;">Dein Profilbild wird von Google √ºbernommen.</p>
        <button id="btn-save-profile" class="btn">NexusPost beitreten</button>
        <p id="setup-error" style="color: red; font-size: 14px;"></p>
    </div>
</div>

<nav id="navbar" class="hidden">
    <b style="color: var(--nexus-blue); font-size: 20px;">NexusPost</b>
    <div>
        <span id="nav-user" style="font-weight: 600; margin-right: 10px;"></span>
        <button onclick="auth.signOut().then(() => location.reload())">Logout</button>
    </div>
</nav>

<div id="main-content" class="container hidden">
    <div class="card">
        <textarea id="post-input" style="width:100%; height:80px; border:none; background:#f0f2f5; border-radius:10px; padding:10px;" placeholder="Was gibt's Neues?"></textarea>
        <button id="btn-share" class="btn" style="margin-top:10px;">Teilen</button>
    </div>
    <div id="feed"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
  apiKey: "AIzaSyCK6bbGtKyuLphYGtxqnAvvnGtMyh2ejV4",
  authDomain: "nexuspost-a00b1.firebaseapp.com",
  projectId: "nexuspost-a00b1",
  storageBucket: "nexuspost-a00b1.firebasestorage.app",
  messagingSenderId: "124843068065",
  appId: "1:124843068065:web:035b15d01910dc6b8d7ee0"
};

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    const adminEmail = "boxenjob5@gmail.com";
    const verifiedIcon = "https://lh3.googleusercontent.com/u/0/d/1c-ECuznD4JebaHyVW7X3FmYG6PggkMsT"; 

    let currentUserData = null;

    // LOGIN
    document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);

    // AUTH CHECKER
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('login-screen').classList.add('hidden');
            const userDoc = await getDoc(doc(db, "users", user.uid));
            
            if (userDoc.exists()) {
                currentUserData = userDoc.data();
                showApp();
            } else {
                document.getElementById('setup-screen').classList.remove('hidden');
                document.getElementById('setup-displayname').value = user.displayName;
            }
        }
    });

    // PROFIL SPEICHERN (Mit Unique Username Check)
    document.getElementById('btn-save-profile').onclick = async () => {
        const username = document.getElementById('setup-username').value.trim().toLowerCase();
        const displayname = document.getElementById('setup-displayname').value.trim();
        const errorEl = document.getElementById('setup-error');

        if (username.length < 3) return errorEl.innerText = "Benutzername zu kurz.";

        // Check ob Username existiert
        const nameRef = doc(db, "usernames", username);
        const nameSnap = await getDoc(nameRef);

        if (nameSnap.exists()) {
            errorEl.innerText = "Benutzername bereits vergeben!";
        } else {
            // 1. Namen reservieren
            await setDoc(nameRef, { uid: auth.currentUser.uid });
            // 2. User Profil erstellen
            const userData = {
                username: username,
                displayname: displayname,
                photoURL: auth.currentUser.photoURL,
                email: auth.currentUser.email
            };
            await setDoc(doc(db, "users", auth.currentUser.uid), userData);
            currentUserData = userData;
            showApp();
        }
    };

    function showApp() {
        document.getElementById('setup-screen').classList.add('hidden');
        document.getElementById('navbar').classList.remove('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        document.getElementById('nav-user').innerText = "@" + currentUserData.username;
        loadFeed();
    }

    // POSTEN
    document.getElementById('btn-share').onclick = async () => {
        const text = document.getElementById('post-input').value;
        if (!text.trim()) return;
        await addDoc(collection(db, "posts"), {
            text: text,
            uid: auth.currentUser.uid,
            username: currentUserData.username,
            displayname: currentUserData.displayname,
            photoURL: currentUserData.photoURL,
            email: currentUserData.email,
            timestamp: serverTimestamp()
        });
        document.getElementById('post-input').value = "";
    };

    // FEED
    function loadFeed() {
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            snapshot.forEach(d => {
                const p = d.data();
                const isVerified = p.email === adminEmail;
                const canDelete = (auth.currentUser.email === adminEmail || auth.currentUser.uid === p.uid);
                
                feed.innerHTML += `
                    <div class="post card">
                        <div style="display:flex; align-items:center;">
                            <img src="${p.photoURL}" class="user-img">
                            <div>
                                <b>${p.displayname}</b> ${isVerified ? `<img src="${verifiedIcon}" class="verified-badge">` : ''}<br>
                                <span class="handle">@${p.username}</span>
                            </div>
                            ${canDelete ? `<button onclick="deletePost('${d.id}')" style="margin-left:auto;">üóëÔ∏è</button>` : ''}
                        </div>
                        <p>${p.text}</p>
                    </div>
                `;
            });
        });
    }

    window.deletePost = (id) => confirm("L√∂schen?") && deleteDoc(doc(db, "posts", id));
</script>
</body>
</html>
