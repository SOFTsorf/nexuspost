<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NexusPost Pro</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --nexus: #1877f2; --bg: #f0f2f5; --card: #ffffff;
            --text: #1c1e21; --sub: #65676b; --border: #dddfe2;
            --ios-input: #f0f2f5; --header-bg: rgba(255, 255, 255, 0.8);
        }
        body.dark {
            --bg: #18191a; --card: #242526; --text: #e4e6eb;
            --sub: #b0b3b8; --border: #3e4042; --ios-input: #3a3b3c;
            --header-bg: rgba(36, 37, 38, 0.8);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0;
            padding-top: 60px; padding-bottom: 90px; transition: 0.3s;
        }

        /* NAVIGATION */
        nav {
            position: fixed; top: 0; left: 0; right: 0; height: 50px;
            background: var(--header-bg); backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 15px; border-bottom: 0.5px solid var(--border); z-index: 1000;
        }
        .logo { font-size: 20px; font-weight: 800; color: var(--nexus); }

        /* CONTAINER & CARDS */
        .container { max-width: 580px; margin: 0 auto; padding: 0 12px; }
        .card { 
            background: var(--card); border-radius: 12px; padding: 12px; 
            margin-bottom: 12px; border: 0.5px solid var(--border); 
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        /* POST ELEMENTS */
        .post-header { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; }
        .user-img { width: 38px; height: 38px; border-radius: 50%; object-fit: cover; }
        .post-img { width: calc(100% + 24px); margin: 10px -12px; cursor: zoom-in; }

        /* KOMMENTAR DESIGN (WIE BEITRÄGE) */
        .comment-section { margin-top: 12px; padding-top: 12px; border-top: 0.5px solid var(--border); }
        .comment-card {
            background: var(--ios-input); border-radius: 12px; padding: 10px;
            margin-bottom: 8px; display: flex; gap: 8px;
        }
        .comment-avatar { width: 30px; height: 30px; border-radius: 50%; }
        .comment-content { flex: 1; }
        .comment-user { font-weight: 600; font-size: 13px; }
        .comment-time { font-size: 11px; color: var(--sub); margin-left: 5px; }
        .comment-text { font-size: 14px; margin-top: 2px; }

        /* INPUT BAR */
        .ios-footer {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--header-bg); backdrop-filter: blur(20px);
            border-top: 0.5px solid var(--border); padding: 10px;
        }
        .input-box {
            display: flex; align-items: center; gap: 10px; max-width: 580px; margin: 0 auto;
        }
        .text-input {
            flex: 1; background: var(--ios-input); border-radius: 20px;
            padding: 8px 15px; min-height: 20px; outline: none;
        }

        .btn-action { background: none; border: none; color: var(--sub); cursor: pointer; display: flex; align-items: center; gap: 5px; font-weight: 600; }
        .btn-send { background: var(--nexus); color: white; border: none; border-radius: 50%; width: 32px; height: 32px; cursor: pointer; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<nav id="navbar" class="hidden">
    <div class="logo">NexusPost</div>
    <div style="display:flex; gap:15px;">
        <button onclick="toggleDarkMode()" class="btn-action"><i data-lucide="moon"></i></button>
    </div>
</nav>

<div id="login-screen" style="text-align:center; padding-top: 100px;">
    <h1 style="color:var(--nexus); font-size:40px;">NexusPost</h1>
    <button id="btn-login" style="background:var(--nexus); color:white; border:none; padding:12px 30px; border-radius:20px; font-weight:bold; cursor:pointer;">Mit Google anmelden</button>
</div>

<main id="main-content" class="container hidden">
    <div id="feed"></div>
</main>

<div id="input-bar" class="ios-footer hidden">
    <div class="input-box">
        <div id="post-input" class="text-input" contenteditable="true" placeholder="Was denkst du?"></div>
        <button id="btn-share" class="btn-send"><i data-lucide="arrow-up"></i></button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCK6bbGtKyuLphYGtxqnAvvnGtMyh2ejV4",
        authDomain: "nexuspost-a00b1.firebaseapp.com",
        projectId: "nexuspost-a00b1",
        storageBucket: "nexuspost-a00b1.firebasestorage.app",
        messagingSenderId: "124843068065",
        appId: "1:124843068065:web:035b15d01910dc6b8d7ee0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    let userData = null;

    function timeAgo(ts) {
        if (!ts) return "jetzt";
        const d = ts.toDate ? ts.toDate() : new Date(ts);
        const sec = Math.floor((new Date() - d) / 1000);
        if (sec < 60) return "gerade eben";
        const min = Math.floor(sec / 60);
        if (min < 60) return min + "m";
        const std = Math.floor(min / 60);
        if (std < 24) return std + "h";
        return Math.floor(std / 24) + "d";
    }

    // AUTH LOGIN
    document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('navbar').classList.remove('hidden');
            document.getElementById('main-content').classList.remove('hidden');
            document.getElementById('input-bar').classList.remove('hidden');
            
            const uRef = doc(db, "users", user.uid);
            const uDoc = await getDoc(uRef);
            if (!uDoc.exists()) {
                userData = { displayname: user.displayName, photoURL: user.photoURL, username: user.email.split('@')[0] };
                await setDoc(uRef, userData);
            } else {
                userData = uDoc.data();
            }
            loadFeed();
        }
    });

    // FEED LADEN
    function loadFeed() {
        const q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        onSnapshot(q, (snap) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = '';
            snap.forEach((postDoc) => {
                const p = postDoc.data();
                const pid = postDoc.id;
                
                // Wir holen die User-Daten für jeden Post (Echtzeit)
                onSnapshot(doc(db, "users", p.uid), (uSnap) => {
                    const u = uSnap.data() || {};
                    const likes = p.likes || [];
                    const hasLiked = likes.includes(auth.currentUser.uid);
                    
                    let card = document.getElementById(`card-${pid}`);
                    if (!card) {
                        card = document.createElement('div');
                        card.id = `card-${pid}`;
                        card.className = 'card';
                        feed.appendChild(card);
                    }

                    card.innerHTML = `
                        <div class="post-header">
                            <img src="${u.photoURL}" class="user-img">
                            <div>
                                <div style="font-weight:700;">${u.displayname}</div>
                                <div style="font-size:12px; color:var(--sub);">@${u.username} • ${timeAgo(p.timestamp)}</div>
                            </div>
                        </div>
                        <div style="white-space:pre-wrap;">${p.text}</div>
                        <div style="display:flex; gap:20px; margin-top:12px;">
                            <button onclick="window.likePost('${pid}', ${JSON.stringify(likes)})" class="btn-action" style="color:${hasLiked ? 'var(--nexus)' : 'inherit'}">
                                <i data-lucide="heart" style="${hasLiked ? 'fill:var(--nexus)' : ''}"></i> ${likes.length}
                            </button>
                            <button onclick="window.toggleComments('${pid}')" class="btn-action">
                                <i data-lucide="message-circle"></i> Kommentare
                            </button>
                        </div>
                        <div id="comments-${pid}" class="comment-section hidden">
                            <div id="comment-list-${pid}"></div>
                            <div style="display:flex; gap:8px; margin-top:10px;">
                                <input type="text" id="comment-in-${pid}" placeholder="Schreibe etwas..." style="flex:1; border:none; background:var(--bg); padding:8px 12px; border-radius:15px; color:var(--text); outline:none;">
                                <button onclick="window.postComment('${pid}')" class="btn-send" style="width:30px; height:30px;"><i data-lucide="send" style="width:14px;"></i></button>
                            </div>
                        </div>
                    `;
                    lucide.createIcons();
                });
            });
        });
    }

    // INTERAKTIONEN
    window.likePost = async (id, likes) => {
        const ref = doc(db, "posts", id);
        const uid = auth.currentUser.uid;
        await updateDoc(ref, { likes: likes.includes(uid) ? arrayRemove(uid) : arrayUnion(uid) });
    };

    window.toggleComments = (pid) => {
        const div = document.getElementById(`comments-${pid}`);
        div.classList.toggle('hidden');
        if (!div.classList.contains('hidden')) loadComments(pid);
    };

    function loadComments(pid) {
        const q = query(collection(db, "posts", pid, "comments"), orderBy("timestamp", "asc"));
        onSnapshot(q, (snap) => {
            const list = document.getElementById(`comment-list-${pid}`);
            list.innerHTML = '';
            snap.forEach(d => {
                const c = d.data();
                list.innerHTML += `
                    <div class="comment-card">
                        <img src="${c.photoURL || 'https://via.placeholder.com/30'}" class="comment-avatar">
                        <div class="comment-content">
                            <div class="comment-user">${c.displayname}<span class="comment-time">${timeAgo(c.timestamp)}</span></div>
                            <div class="comment-text">${c.text}</div>
                        </div>
                    </div>
                `;
            });
        });
    }

    window.postComment = async (pid) => {
        const input = document.getElementById(`comment-in-${pid}`);
        if (!input.value.trim()) return;
        await addDoc(collection(db, "posts", pid, "comments"), {
            text: input.value,
            uid: auth.currentUser.uid,
            displayname: userData.displayname,
            photoURL: userData.photoURL,
            timestamp: serverTimestamp()
        });
        input.value = '';
    };

    // NEUER POST
    document.getElementById('btn-share').onclick = async () => {
        const input = document.getElementById('post-input');
        if (!input.innerText.trim()) return;
        await addDoc(collection(db, "posts"), {
            text: input.innerText,
            uid: auth.currentUser.uid,
            timestamp: serverTimestamp(),
            likes: []
        });
        input.innerText = '';
    };

    window.toggleDarkMode = () => {
        document.body.classList.toggle('dark');
        lucide.createIcons();
    };

</script>
</body>
</html>
