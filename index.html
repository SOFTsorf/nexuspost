<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>NexusPost Pro</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --nexus: #1877f2; --bg: #f0f2f5; --card: #ffffff;
            --text: #1c1e21; --sub: #65676b; --border: #dddfe2; --header-bg: rgba(255, 255, 255, 0.8);
            --ios-input: #efeff0;
        }
        body.dark {
            --bg: #000000; --card: #1c1c1e; --text: #ffffff;
            --sub: #8e8e93; --border: #38383a; --header-bg: rgba(28, 28, 30, 0.8);
            --ios-input: #2c2c2e;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg); color: var(--text); margin: 0; padding-top: 60px; padding-bottom: 90px;
        }

        /* iOS Nav & Search */
        nav {
            position: fixed; top: 0; width: 100%; height: 50px; background: var(--header-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: space-between; padding: 0 15px;
            border-bottom: 0.5px solid var(--border); z-index: 1000; box-sizing: border-box;
        }
        .search-wrapper { display: flex; align-items: center; flex-grow: 1; transition: 0.3s; }
        .search-container {
            display: flex; align-items: center; background: var(--ios-input);
            border-radius: 10px; padding: 0 10px; height: 36px; flex-grow: 1; margin: 0 10px;
        }
        .search-input { border: none; background: none; color: var(--text); width: 100%; outline: none; font-size: 16px; }
        .cancel-btn { color: var(--nexus); font-weight: 500; cursor: pointer; padding-right: 5px; display: none; }

        /* Settings & Profile Style */
        .settings-card { background: var(--card); border-radius: 12px; overflow: hidden; margin-top: 20px; border: 0.5px solid var(--border); }
        .settings-item { 
            display: flex; align-items: center; padding: 12px 15px; 
            border-bottom: 0.5px solid var(--border); gap: 15px;
        }
        .settings-item:last-child { border-bottom: none; }
        .settings-label { width: 100px; font-size: 15px; color: var(--sub); }
        .settings-val { flex-grow: 1; border: none; background: none; color: var(--text); font-size: 16px; outline: none; }
        
        .profile-pic-upload {
            width: 80px; height: 80px; border-radius: 50%; object-fit: cover;
            border: 2px solid var(--nexus); cursor: pointer; margin: 20px auto; display: block;
        }

        .btn-blue { 
            background: var(--nexus); color: white; border: none; width: 100%; 
            padding: 12px; border-radius: 10px; font-weight: 600; margin-top: 20px; cursor: pointer;
        }

        .container { max-width: 580px; margin: 0 auto; padding: 0 15px; }
        .card { background: var(--card); border-radius: 14px; padding: 15px; margin-bottom: 12px; border: 0.5px solid var(--border); }
        .hidden { display: none !important; }
        .verified-badge { width: 16px; height: 16px; vertical-align: middle; pointer-events: none; }
    </style>
</head>
<body class="light">

<nav id="navbar" class="hidden">
    <div class="logo" id="nav-logo" style="font-weight: 700; font-size: 20px;">NexusPost</div>
    <div class="search-wrapper" id="search-wrapper">
        <div class="search-container">
            <i data-lucide="search" size="18" style="color: var(--sub);"></i>
            <input type="text" id="search-input" class="search-input" placeholder="Suchen..." onfocus="expandSearch()">
        </div>
        <span id="search-cancel" class="cancel-btn" onclick="collapseSearch()">Abbrechen</span>
    </div>
    <div id="nav-actions" style="display: flex; gap: 15px;">
        <i data-lucide="moon" onclick="toggleDarkMode()" style="cursor: pointer;"></i>
        <i data-lucide="settings" onclick="openSettings()" style="cursor: pointer;"></i>
    </div>
</nav>

<div id="setup-screen" class="container hidden" style="padding-top: 50px; text-align: center;">
    <h1 style="letter-spacing: -1px;">Profil einrichten</h1>
    <p style="color: var(--sub);">Wähle ein Bild und Namen für deinen Account.</p>
    <label>
        <img id="setup-preview" src="https://via.placeholder.com/150" class="profile-pic-upload">
        <input type="file" id="setup-img-input" accept="image/*" class="hidden" onchange="previewProfilePic(this, 'setup-preview')">
    </label>
    <div class="settings-card">
        <div class="settings-item"><span class="settings-label">Name</span><input type="text" id="setup-displayname" class="settings-val" placeholder="Dein Name"></div>
        <div class="settings-item"><span class="settings-label">@Username</span><input type="text" id="setup-username" class="settings-val" placeholder="benutzername"></div>
    </div>
    <button class="btn-blue" onclick="completeSetup()">Starten</button>
</div>

<div id="settings-screen" class="container hidden" style="padding-top: 20px;">
    <h2 style="margin-left: 10px;">Einstellungen</h2>
    <label>
        <img id="settings-preview" src="" class="profile-pic-upload">
        <input type="file" id="settings-img-input" accept="image/*" class="hidden" onchange="previewProfilePic(this, 'settings-preview')">
    </label>
    <div class="settings-card">
        <div class="settings-item"><span class="settings-label">Name</span><input type="text" id="edit-displayname" class="settings-val"></div>
        <div class="settings-item"><span class="settings-label">Username</span><input type="text" id="edit-username" class="settings-val"></div>
    </div>
    <p id="edit-warning" style="font-size: 12px; color: var(--sub); padding: 10px;"></p>
    <button class="btn-blue" onclick="saveSettings()">Speichern</button>
    <button style="width: 100%; background: none; border: none; color: var(--nexus); margin-top: 15px; cursor: pointer;" onclick="closeSettings()">Abbrechen</button>
</div>

<main id="main-content" class="container hidden">
    <div id="feed"></div>
</main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = { /* DEINE CONFIG HIER REINKOPIEREN */ };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();
    const imgbbKey = "1cb3871dd6829d7133f3285c289ffc0a";

    let userData = null;

    // --- LOGIK: SUCHE ---
    window.expandSearch = () => {
        document.getElementById('nav-logo').classList.add('hidden');
        document.getElementById('nav-actions').classList.add('hidden');
        document.getElementById('search-cancel').style.display = 'block';
    };
    window.collapseSearch = () => {
        document.getElementById('nav-logo').classList.remove('hidden');
        document.getElementById('nav-actions').classList.remove('hidden');
        document.getElementById('search-cancel').style.display = 'none';
        document.getElementById('search-input').value = "";
    };

    // --- LOGIK: PROFILBILD PREVIEW ---
    window.previewProfilePic = (input, imgId) => {
        const file = input.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => document.getElementById(imgId).src = e.target.result;
            reader.readAsDataURL(file);
        }
    };

    // --- AUTH & ONBOARDING ---
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            const uDoc = await getDoc(doc(db, "users", user.uid));
            if (uDoc.exists()) {
                userData = uDoc.data();
                showMainApp();
            } else {
                document.getElementById('setup-screen').classList.remove('hidden');
            }
        } else {
            // Zeige Login (hier verkürzt)
            signInWithPopup(auth, provider);
        }
    });

    window.completeSetup = async () => {
        const dName = document.getElementById('setup-displayname').value;
        const uName = document.getElementById('setup-username').value;
        const file = document.getElementById('setup-img-input').files[0];
        if (!dName || !uName || !file) return alert("Bitte alles ausfüllen!");

        const photoURL = await uploadImage(file);
        userData = {
            displayname: dName,
            username: uName.toLowerCase(),
            photoURL: photoURL,
            email: auth.currentUser.email,
            verified: false,
            editHistory: [] // Speichert Zeitstempel der Namensänderungen
        };
        await setDoc(doc(db, "users", auth.currentUser.uid), userData);
        document.getElementById('setup-screen').classList.add('hidden');
        showMainApp();
    };

    // --- SETTINGS MIT 14-TAGE-REGEL ---
    window.openSettings = () => {
        document.getElementById('main-content').classList.add('hidden');
        document.getElementById('settings-screen').classList.remove('hidden');
        document.getElementById('settings-preview').src = userData.photoURL;
        document.getElementById('edit-displayname').value = userData.displayname;
        document.getElementById('edit-username').value = userData.username;
        
        const changes = getRecentChangesCount();
        document.getElementById('edit-warning').innerText = `Du hast deinen Namen ${changes}/2 Mal in den letzten 14 Tagen geändert.`;
    };

    function getRecentChangesCount() {
        const now = Date.now();
        const fourteenDays = 14 * 24 * 60 * 60 * 1000;
        return (userData.editHistory || []).filter(ts => (now - ts) < fourteenDays).length;
    }

    window.saveSettings = async () => {
        const newDName = document.getElementById('edit-displayname').value;
        const newUName = document.getElementById('edit-username').value;
        const file = document.getElementById('settings-img-input').files[0];
        
        let updates = {};
        
        if (newDName !== userData.displayname || newUName !== userData.username) {
            if (getRecentChangesCount() >= 2) return alert("Limit erreicht! Du kannst deinen Namen erst in 14 Tagen wieder ändern.");
            updates.displayname = newDName;
            updates.username = newUName;
            updates.editHistory = [...(userData.editHistory || []), Date.now()];
        }

        if (file) updates.photoURL = await uploadImage(file);

        await updateDoc(doc(db, "users", auth.currentUser.uid), updates);
        location.reload(); // Einfachster Weg um Daten zu refreshen
    };

    async function uploadImage(file) {
        const fd = new FormData(); fd.append("image", file);
        const res = await fetch(`https://api.imgbb.com/1/upload?key=${imgbbKey}`, { method: "POST", body: fd });
        const json = await res.json();
        return json.data.url;
    }

    function showMainApp() {
        document.getElementById('navbar').classList.remove('hidden');
        document.getElementById('main-content').classList.remove('hidden');
        lucide.createIcons();
        /* Hier loadFeed() etc aufrufen */
    }
</script>
</body>
</html>
