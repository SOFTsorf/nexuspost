<div id="settings-screen" class="container hidden" style="padding-top: 20px;">
    <h2 style="margin-left: 5px; margin-bottom: 20px;">Einstellungen</h2>
    <button id="btn-save-settings" class="send-btn" style="width:100%; border-radius:12px; height:50px; font-weight:600;">Speichern</button>
    
    <button onclick="auth.signOut().then(()=>location.reload())" class="btn-cancel" style="margin-top:20px; border: 1px solid var(--danger); border-radius:12px;">Abmelden</button>
    
    <button onclick="toggleSettings()" class="btn-cancel">Abbrechen</button>
</div>

<div id="profile-view-header" class="container hidden" style="padding: 20px 15px; background: var(--card); border-bottom: 0.5px solid var(--border);">
    <button onclick="closeProfileView()" style="background:none; border:none; color:var(--nexus); font-weight:600; margin-bottom:10px; display:flex; align-items:center; gap:5px;">
        <i data-lucide="arrow-left" style="width:18px;"></i> ZurÃ¼ck zum Feed
    </button>
    <div style="display:flex; align-items:center; gap:15px;">
        <img id="view-p-img" src="" class="user-img" style="width:60px; height:60px;">
        <div style="flex-grow:1;">
            <div id="view-p-name" style="font-size:20px; font-weight:800;"></div>
            <div id="view-p-handle" style="color:var(--sub);"></div>
        </div>
        <button id="btn-follow" class="send-btn" style="width:auto; padding:0 20px; border-radius:20px;">Folgen</button>
    </div>
    <div style="display:flex; gap:20px; margin-top:15px; font-size:14px;">
        <span><strong id="count-followers">0</strong> Follower</span>
        <span><strong id="count-following">0</strong> Folgt</span>
    </div>
</div>

<script type="module">
    // ... deine Firebase Imports ...
    import { signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- PROFIL ANSICHT LOGIK ---
    let isProfileView = false;
    let currentProfileUid = null;

    window.openProfile = async (uid) => {
        isProfileView = true;
        currentProfileUid = uid;
        
        const uSnap = await getDoc(doc(db, "users", uid));
        const u = uSnap.data();
        
        // UI fÃ¼llen
        document.getElementById('view-p-img').src = u.photoURL;
        document.getElementById('view-p-name').innerText = u.displayname;
        document.getElementById('view-p-handle').innerText = "@" + u.username;
        document.getElementById('profile-view-header').classList.remove('hidden');
        
        // Follow Button Check
        updateFollowUI(u, uid);
        
        // Feed filtern
        loadFeed(uid);
    };

    window.closeProfileView = () => {
        isProfileView = false;
        document.getElementById('profile-view-header').classList.add('hidden');
        loadFeed(); // Zeige wieder alles
    };

    async function updateFollowUI(u, uid) {
        const btn = document.getElementById('btn-follow');
        if(uid === auth.currentUser.uid) {
            btn.classList.add('hidden');
        } else {
            btn.classList.remove('hidden');
            const following = u.followers || [];
            const isFollowing = following.includes(auth.currentUser.uid);
            btn.innerText = isFollowing ? "Gefolgt" : "Folgen";
            btn.onclick = () => toggleFollow(uid, isFollowing);
        }
        document.getElementById('count-followers').innerText = (u.followers || []).length;
        document.getElementById('count-following').innerText = (u.following || []).length;
    }

    async function toggleFollow(targetUid, isFollowing) {
        const myRef = doc(db, "users", auth.currentUser.uid);
        const targetRef = doc(db, "users", targetUid);
        if(isFollowing) {
            await updateDoc(myRef, { following: arrayRemove(targetUid) });
            await updateDoc(targetRef, { followers: arrayRemove(auth.currentUser.uid) });
        } else {
            await updateDoc(myRef, { following: arrayUnion(targetUid) });
            await updateDoc(targetRef, { followers: arrayUnion(auth.currentUser.uid) });
        }
        openProfile(targetUid); // Refresh
    }

    // --- AKTUALISIERTES FEED-RENDERING ---
    function loadFeed(filterUid = null) {
        let q = query(collection(db, "posts"), orderBy("timestamp", "desc"));
        if(filterUid) {
            // Hinweis: Falls Firebase meckert, muss ein Index erstellt werden (Link in der Konsole)
            q = query(collection(db, "posts"), where("uid", "==", filterUid), orderBy("timestamp", "desc"));
        }

        onSnapshot(q, (snap) => {
            const feed = document.getElementById('feed');
            feed.innerHTML = "";
            snap.forEach((d) => {
                const p = d.data();
                onSnapshot(doc(db, "users", p.uid), (uSnap) => {
                    const u = uSnap.data() || {};
                    const pid = 'post-'+d.id;
                    const likes = Array.isArray(p.likes) ? p.likes : [];
                    const hasLiked = likes.includes(auth.currentUser.uid);

                    const html = `
                        <div class="post-header" onclick="openProfile('${p.uid}')" style="cursor:pointer">
                            <img src="${u.photoURL}" class="user-img">
                            <div style="flex-grow:1">
                                <div class="display-name">${u.displayname} ${u.verified ? 'ðŸ”¹' : ''}</div>
                                <div style="font-size:13px; color:var(--sub);">@${u.username}</div>
                            </div>
                        </div>
                        <div style="font-size:16px; white-space:pre-wrap; padding: 5px 0;">${p.text}</div>
                        ${p.imageUrl ? `<img src="${p.imageUrl}" class="post-img" onclick="openLightbox('${p.imageUrl}')">` : ''}
                        
                        <div style="display: flex; gap: 20px; margin-top: 15px; border-top: 0.5px solid var(--border); padding-top: 10px;">
                            <button onclick='toggleLike("${d.id}", ${JSON.stringify(likes)})' style="background:none; border:none; color:${hasLiked?'var(--nexus)':'var(--sub)'}; cursor:pointer; display:flex; align-items:center; gap:5px;">
                                <i data-lucide="heart" style="width:18px; ${hasLiked?'fill:var(--nexus)':''}"></i> ${likes.length}
                            </button>
                            <button onclick="showComments('${d.id}')" style="background:none; border:none; color:var(--sub); cursor:pointer; display:flex; align-items:center; gap:5px;">
                                <i data-lucide="message-circle" style="width:18px;"></i> Kommentare
                            </button>
                        </div>
                        <div id="comments-section-${d.id}" class="hidden" style="margin-top:15px; padding-top:10px; border-top: 0.5px solid var(--border);">
                            </div>`;
                    
                    let div = document.getElementById(pid);
                    if (!div) { div = document.createElement('div'); div.id = pid; div.className = 'card'; feed.appendChild(div); }
                    div.innerHTML = html; lucide.createIcons();
                });
            });
        });
    }

    // --- KOMMENTARE IM POST-STYLE ---
    window.showComments = (pId) => {
        const sec = document.getElementById(`comments-section-${pId}`);
        sec.classList.toggle('hidden');
        if (!sec.classList.contains('hidden')) {
            sec.innerHTML = `
                <div style="display:flex; gap:8px; margin-bottom:15px;">
                    <input type="text" id="input-${pId}" placeholder="Antworten..." style="flex-grow:1; padding:10px; border-radius:20px; border:0.5px solid var(--border); background:var(--bg); color:var(--text);">
                    <button onclick="addComment('${pId}')" class="send-btn"><i data-lucide="arrow-up" style="width:16px;"></i></button>
                </div>
                <div id="list-${pId}"></div>`;
            lucide.createIcons();

            onSnapshot(query(collection(db, "posts", pId, "comments"), orderBy("timestamp", "asc")), (snap) => {
                const list = document.getElementById(`list-${pId}`);
                if (!list) return;
                list.innerHTML = '';
                snap.forEach(ds => {
                    const c = ds.data();
                    // Kommentar als "Mini-Card"
                    list.innerHTML += `
                        <div style="display:flex; gap:10px; margin-bottom:12px; background:var(--bg); padding:10px; border-radius:12px; border: 0.5px solid var(--border);">
                            <img src="${c.photoURL}" style="width:30px; height:30px; border-radius:50%;" onclick="openProfile('${c.uid}')">
                            <div>
                                <div style="font-size:13px; font-weight:700;">${c.displayname}</div>
                                <div style="font-size:14px; color:var(--text);">${c.text}</div>
                            </div>
                        </div>`;
                });
            });
        }
    };
</script>
